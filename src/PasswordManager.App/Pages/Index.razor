@page "/"
@inject ApiClient ApiClient
@inject AuthState AuthState
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar

@if (!AuthState.IsAuthenticated)
{
    <MudPaper Class="pa-8 mx-auto login-card modern-surface" MaxWidth="MaxWidth.Small" Elevation="4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Primary" />
            <MudText Typo="Typo.h5">Acesse o cofre</MudText>
        </MudStack>
        <MudText Typo="Typo.body2" Class="mb-4 text-muted">Faça login para gerenciar suas senhas com segurança.</MudText>

        <MudTextField Label="Usuário" @bind-Value="login.Username" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />
        <MudTextField Label="Senha" InputType="InputType.Password" @bind-Value="login.Password" Variant="Variant.Outlined" Class="mt-3" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Lock" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PerformLogin" Class="mt-4" FullWidth="true" StartIcon="@Icons.Material.Filled.Login" Loading="isLoggingIn" Disabled="isLoggingIn">Entrar</MudButton>


        @if (!string.IsNullOrWhiteSpace(loginError))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">@loginError</MudAlert>
        }
    </MudPaper>
}
else
{
    <MudGrid>
        <MudItem xs="12" md="5">
            <MudPaper Class="pa-5 modern-surface" Elevation="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                    <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Nova senha</MudText>
                </MudStack>
                <MudText Typo="Typo.body2" Class="mb-4 text-muted">Crie e salve uma credencial com aparência profissional.</MudText>

                <MudTextField Label="Descrição" @bind-Value="form.Description" Variant="Variant.Outlined" />
                <MudTextField Label="Usuário/Login" @bind-Value="form.Username" Variant="Variant.Outlined" Class="mt-3" />
                <MudTextField Label="Senha" @bind-Value="form.Password" Variant="Variant.Outlined" Class="mt-3" />

                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" OnClick="Generate" StartIcon="@Icons.Material.Filled.AutoFixHigh" Disabled="isGenerating" Loading="isGenerating">Gerar automática</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="Save" StartIcon="@Icons.Material.Filled.Save" Disabled="isSaving" Loading="isSaving">Salvar</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => CopyPassword(form.Password))" StartIcon="@Icons.Material.Filled.ContentCopy" Disabled="isCopying">Copiar senha</MudButton>
                </MudStack>

                @if (!string.IsNullOrWhiteSpace(lastCreatedPassword))
                {
                    <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Dense="true" Class="mt-4">
                        Senha criada com sucesso: <strong>@lastCreatedPassword</strong>
                        <MudButton Size="Size.Small" Variant="Variant.Text" Class="ml-2" StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="@(() => CopyPassword(lastCreatedPassword))">
                            Copiar
                        </MudButton>
                    </MudAlert>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="7">
            <MudPaper Class="pa-5 modern-surface" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudText Typo="Typo.h6">Senhas cadastradas</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Reload" StartIcon="@Icons.Material.Filled.Refresh">Atualizar</MudButton>
                </MudStack>

                <MudTable Items="passwords" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Descrição</MudTh>
                        <MudTh>Usuário</MudTh>
                        <MudTh>Senha</MudTh>
                        <MudTh>Criada em</MudTh>
                        <MudTh>Ações</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Descrição">@context.Description</MudTd>
                        <MudTd DataLabel="Usuário">@context.Username</MudTd>
                        <MudTd DataLabel="Senha">@context.Secret</MudTd>
                        <MudTd DataLabel="Criada em">@context.CreatedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</MudTd>
                        <MudTd DataLabel="Ações">
                            <MudStack Row="true" Spacing="1">
                                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Primary" Size="Size.Small" OnClick="@(() => CopyPassword(context.Secret))" aria-label="Copiar senha" />
                                <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete" OnClick="@(() => DeletePassword(context.Id))" Loading="deletingPasswordId == context.Id" Disabled="deletingPasswordId == context.Id">
                                </MudButton>
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private LoginRequest login = new();
    private string? loginError;

    private CreatePasswordRequest form = new();
    private List<PasswordEntry> passwords = [];
    private string? lastCreatedPassword;
    private bool isGenerating;
    private bool isSaving;
    private bool isCopying;
    private bool isLoggingIn;
    private Guid? deletingPasswordId;

    protected override async Task OnInitializedAsync()
    {
        if (AuthState.IsAuthenticated)
        {
            await Reload();
        }
    }

    private async Task PerformLogin()
    {
        loginError = null;
        try
        {
            isLoggingIn = true;
            var success = await ApiClient.LoginAsync(login);
            if (!success)
            {
                loginError = "Usuário ou senha inválidos.";
                return;
            }

            await Reload();
        }
        finally
        {
            isLoggingIn = false;
        }
    }

    private async Task Generate()
    {
        try
        {
            isGenerating = true;
            var generated = await ApiClient.GeneratePasswordAsync(new GeneratePasswordRequest());
            form = form with { Password = generated };
            Snackbar.Add("Senha gerada com sucesso.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Não foi possível gerar a senha no momento.", Severity.Error);
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task DeletePassword(Guid id)
    {
        try
        {
            deletingPasswordId = id;
            await ApiClient.DeletePasswordAsync(id);
            await Reload();
            Snackbar.Add("Senha excluída com sucesso.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Não foi possível excluir a senha.", Severity.Error);
        }
        finally
        {
            deletingPasswordId = null;
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(form.Description) || string.IsNullOrWhiteSpace(form.Username))
        {
            Snackbar.Add("Informe descrição e usuário para salvar.", Severity.Warning);
            return;
        }

        try
        {
            isSaving = true;
            var created = await ApiClient.CreatePasswordAsync(form);
            lastCreatedPassword = created?.Secret;
            form = new CreatePasswordRequest();
            await Reload();
            Snackbar.Add("Senha salva com sucesso.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Não foi possível salvar a senha.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task CopyPassword(string? password)
    {
        if (string.IsNullOrWhiteSpace(password))
        {
            Snackbar.Add("Não há senha para copiar.", Severity.Warning);
            return;
        }

        try
        {
            isCopying = true;
            await JsRuntime.InvokeVoidAsync("appClipboard.copyText", password);
            Snackbar.Add("Senha copiada para a área de transferência.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Não foi possível copiar a senha.", Severity.Error);
        }
        finally
        {
            isCopying = false;
        }
    }

    private async Task Reload()
    {
        passwords = (await ApiClient.GetPasswordsAsync()).ToList();
    }
}
